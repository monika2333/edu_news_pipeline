# 新闻流水线近期改造计划

## 目标
- 在不调整现有流程和表结构的前提下，仅对 `raw_articles` 增补所需字段，实现：
  1. 正负向情感标签的生成与存储；
  2. 基于哈希与指纹的重复新闻识别。

## 数据库调整
对 `raw_articles` 新增如下字段：
- `content_hash` (text)：正文内容的哈希值（建议使用 SHA256），用于快速识别完全重复的文章。
- `fingerprint` (text 或 bytea)：正文指纹（如 SimHash/MinHash），用于判断相似但不完全相等的文章。
- `sentiment_label` (text)：情感标签，取值 `positive` 或 `negative`。
- `sentiment_confidence` (numeric)：情感标签的置信度（0-1）。
- （可选）如需追踪模型版本或重算时间，可于后续阶段再补充相应字段。

（如有需要，可同步刷新相应索引或视图，但本阶段不新增其他表。）

## 处理流程
1. **采集写入**  
   - 爬虫或采集脚本在写入 `raw_articles` 时生成 `content_hash`。  
   - 对无法立即计算指纹的记录，标记待处理并进入补算任务。

2. **指纹计算任务**  
   - 批量读取缺少 `fingerprint` 的文章，使用选定算法生成指纹并写回。  
   - 保留算法与参数配置，方便未来调整。

3. **情感分类任务**  
- 采用“小模型优先 + 大模型兜底”策略：先调用 `.env` 中配置的 `SENTIMENT_SMALL_MODEL_NAME`，若置信度低于 `SENTIMENT_CONFIDENCE_THRESHOLD`，再使用 `SENTIMENT_MODEL_NAME`。  
- 将最终标签与置信度写入 `raw_articles` 对应字段。

4. **重复识别与过滤**  
   - 首先根据 `content_hash` 判断完全重复，必要时直接标记为重复或从候选列表中剔除。  
   - 对哈希不同但指纹距离低于阈值的文章，归为重复集合，后续在报送或人工审核时折叠/隐藏。

## 运维与监控
- 监控每日新文章在情感标签中的分布、调用大模型的比例、重复命中率。  
- 建立重算脚本：当算法或模型升级时，可按时间区间重新计算指纹或情感标签。  
- 保留原始 `content_markdown`，确保未来需要更复杂功能时可以复用现有数据。
