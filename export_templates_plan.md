# 导出模板改造方案（综报 / 晚报 / 预览）

## 目标
- 导出时直接生成最终排版文本，支持综报/晚报两种模板。
- 支持预览：不写文件、不标记 exported，仅返回排版文本供复制。
- 支持期号自动计算，前端可手动覆盖。

## 数据分组与排序
- 分组依据：地域 `is_beijing_related` => 京内/京外；情感 `sentiment_label` => 正面/负面。
- 排序：沿用现有 `manual_rank` 优先，其次 score，再其次发布时间。

## 模板排版
- 综报头部三行：
  1) `首都教育每日舆情综报`
  2) `{year}年第{period}期（总第{total}期）`
  3) `{date}`（YYYY年MM月DD日）
- 综报分组顺序与栏目名称（映射情感/地域）：
  - 【重点关注舆情】= 京内负面，每条：`★ 标题` 换行 `摘要（来源）`
  - 【新闻信息纵览】= 京内正面，每条：`■ 标题` 换行 `摘要（来源）`
  - 【国内教育热点】= 京外负面，每条：`▲ 标题` 换行 `摘要（来源）`
- 晚报头部三行（固定文案）：
  1) `首都教育舆情`
  2) `总第{total}期`
  3) `{date}`（YYYY年MM月DD日）
- 晚报分组顺序与栏目名称：
  - 【舆情速览】= 京内正面，编号 `一、二、三...` + 标题；下一行 `摘要（来源）`
  - 【舆情参考】= 京外正面，编号同上。

## 期号规则
- 综报与晚报各自独立计数。
- 综报：每天自增 1 期。
- 晚报：每天自增 2 期。
- 后端自动计算 period/total，前端可手动修改；传入值则直接使用、跳过自增计算。

## 后端改动
- `ExportRequest` 增加字段：
  - `template`: `zongbao` / `wanbao`
  - `period`, `total_period`: 可选；为空则按上述规则自动计算。
  - `mark_exported`: 默认为 true，控制是否标记导出。
  - `dry_run`: 预览开关，true 时不写文件、不标记 exported，仅返回文本。
- `export_batch` 逻辑：
  - 按 `template` 选择分组顺序与格式化函数（头部和栏目名称不同）。
  - `dry_run=true` 时仅生成文本，不写文件、不更新状态。
  - 返回实际使用的 `period`、`total_period`、`template`，便于前端提示。
- 自动期号计算思路：
  - 以模板维度查询最新导出的记录，按“每天+1”（综报）或“每天+2”（晚报）产生下一期。
  - 需要记录最后一次的 period/total 及日期；查不到则用配置的起始值。

## 前端改动
- 导出弹窗：
  - 模板选择：综报 / 晚报。
  - 期号输入：`period`、`total_period`，默认填入后端返回的建议值，允许用户修改。
  - 导出模式：预览开关（“预览”）。
  - “标记为已导出”勾选（默认开）；预览时灰掉且为关。
- 交互流程建议：
  - 打开弹窗时请求“导出预览/建议”接口获取：建议期号、默认模板文本预览。
  - 用户修改后点击“预览”仅刷新文本；点击“正式导出”才写文件并按勾选标记 exported。

## 多次导出处理
- 选项 A（推荐）：预览 + 标记勾选
  - 预览：`dry_run=true`，不标记。
  - 正式导出：`dry_run=false`，可选 `mark_exported`（默认 true）；补充导出时可临时关闭标记。
- 选项 B：延迟归档
  - 导出后暂不转为 exported，用户点击“完成导出并归档”时再标记 exported。

## 预览行为
- 预览仅返回排版好的文本，不写文件、不更新任何状态。
