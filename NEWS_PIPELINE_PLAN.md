# 新闻流水线近期改造计划（最小实现）

## 目标
- **情感标签**：为每篇文章生成正/负向标签，并记录置信度。
- **重复检测**：基于正文哈希与指纹识别重复新闻，在候选列表中剔除或折叠重复项。

本阶段只改动 `raw_articles` 表，其余结构与流程保持不变。

## 数据库调整（仅 `raw_articles`）
- `content_hash` (`text`)：正文哈希值（建议 SHA256），用于快速识别完全重复的文章。  
  - 索引：`BTREE (content_hash)`。
- `fingerprint` (`text`)：64 位 SimHash 指纹，用于判定高度相似的文章。  
  - 索引：可根据执行效果再决定是否建立（如 `BTREE` 或 `GIN`/`SP-GiST`）。  
  - 指纹为空时不参与重复判断。
- `primary_article_id` (`text`)：指向保留的主文章 ID；主文写入自身 `article_id`，从文写入主文的 `article_id`。  
  - 索引：`BTREE (primary_article_id)`，便于查询重复集合。
- `sentiment_label` (`text`)：情感标签，取值 `positive` 或 `negative`。
- `sentiment_confidence` (`numeric`)：情感判断置信度（0~1）。

> 迁移脚本需为历史数据增加新列并回填：`primary_article_id` 先设为 `article_id`，`content_hash` 可直接计算，`fingerprint` 与 `sentiment_*` 可后续任务补齐。

## 重复检测策略
1. **内容哈希**：写入时生成 `content_hash`。相同哈希直接视为完全重复，保留主文、其余记录标记为从文。
2. **SimHash 指纹**：  
   - 使用 64 位 SimHash；根据以下汉明距离阈值判断：

     | 内容类型             | 阈值范围 | 说明               |
     | -------------------- | -------- | ------------------ |
     | 完全相同             | 0        | 文本一致           |
     | 高度相似（改写稿）   | 1–3      | 仅个别词不同       |
     | 中度相似（同题不同角度） | 4–6      | 可记作同一事件聚合 |
     | 无关内容             | >10      | 判为独立文章       |

   - 当前阶段：阈值 ≤3 视为重复加入同一集合；4–6 的文章只记录匹配得分，待未来事件聚合阶段再处理。
3. **主文选择**：同一集合内，按“来源优先级 + 发布时间最早”确定主文。来源优先级为：新华网 ＞ 人民网 ＞ 光明日报 ＞ 新京报 ＞北京日报 ＞ 中国教育报 ＞ 其他地方媒体；若优先级相同，则发布时间最早者为主文。
4. **候选过滤**：生成候选列表或报告时，仅展示 `primary_article_id = article_id` 的主文；从文可折叠展示或直接剔除。
5. **缺失处理**：正文缺失或过短无法计算哈希/指纹的记录，直接跳过，只保留原始内容待人工处理。

## 情感分类流程
1. 写入任务读取新增文章，先调用 `.env` 中配置的本地小模型（`SENTIMENT_SMALL_MODEL_NAME`）。  
2. 若小模型置信度低于 `SENTIMENT_CONFIDENCE_THRESHOLD`，再调用大模型（`SENTIMENT_MODEL_NAME`）。  
3. 将最终标签与置信度写入 `sentiment_label`、`sentiment_confidence`；可记录低置信度样本供人工回查。
4. 小模型部署在本地服务，大模型调用额度充足无需额外限制。

## 实施步骤
1. **数据库迁移**：新增字段与索引，对历史数据执行回填脚本（`content_hash`、`primary_article_id`）。  
2. **指纹与情感任务**：实现批处理/队列任务，补齐历史数据并处理增量；对失败记录重试并写日志。  
3. **候选/报告筛选**：更新查询逻辑，只输出主文，确保重复条目不再进入人工候选列表。  
4. **监控与调优**：上线后监控情感分布、大模型调用比例、重复命中率、指纹生成成功率，并根据反馈调整阈值或主文选择规则。

## 运行维护
- **重算计划**：当指纹算法或阈值调整时，可按时间段重新计算 `fingerprint` 或重新跑情感分类任务。  
- **配置管理**：在 `.env` 中统一维护模型名称、置信度阈值、指纹参数。  
- **数据回溯**：保留原始 `content_markdown` 和历史字段，确保未来扩展事件聚合或评分功能时可直接复用。
