# 导出模板改造方案（综报 / 晚报 / 预览）

## 目标
- 导出时直接生成最终排版文本，支持综报/晚报两种模板。
- 支持预览：不写文件、不标记 exported，仅返回排版文本供复制。
- 支持期号自动计算，前端可手动覆盖。

## 数据分组与排序
- 分组依据：地域 `is_beijing_related` => 京内/京外；情感 `sentiment_label` => 正面/负面。
- 排序：沿用现有 `manual_rank` 优先，其次 score，再其次发布时间。

## 模板排版（示例）
- 综报头部三行：
  1) `首都教育每日舆情综报`
  2) `{year}年第{period}期（总第{total}期）`
  3) `{date}`（YYYY年MM月DD日）
- 综报分组顺序与符号：
  - 【京内负面】每条：`★ 标题` 换行 `摘要（来源）`
  - 【京内正面】每条：`■ 标题` 换行 `摘要（来源）`
  - 【京外负面】每条：`▲ 标题` 换行 `摘要（来源）`
- 晚报头部三行（固定文案）：
  1) `首都教育舆情`
  2) `总第{total}期`
  3) `{date}`（YYYY年MM月DD日）
- 晚报分组顺序与编号：
  - 【京内正面】：编号 `一、二、三...` + 标题；下一行 `摘要（来源）`
  - 【京外正面】：同上编号。

## 后端改动
- `ExportRequest` 增加字段：
  - `template`: `zongbao` / `wanbao`
  - `period`, `total_period`: 可选；为空则自动计算，传入则直接使用。
  - `mark_exported`: 默认为 true，控制是否标记导出。
  - `dry_run`: 预览开关，true 时不写文件、不标记 exported。
  - 可选 `mode`: `full` / `incremental`（若要支持增量导出）。
- `export_batch` 逻辑：
  - 根据 `template` 选择分组顺序与格式化函数（综报/晚报头部与正文格式不同）。
  - `dry_run=true` 时仅生成文本并返回，不写文件、不更新状态。
  - `mark_exported` 受 `dry_run` 影响：预览时强制不标记；正式导出按勾选执行。
  - 返回实际使用的 `period`、`total_period`、`template`，便于前端提示。
- 自动期号计算思路：
  - 后端查询最新导出的记录（可按模板分组或全局），得到上一期的 period/total，自增作为建议值。
  - 若查不到则用配置的起始值。
  - 若前端传入 period/total，则跳过计算，直接使用。

## 前端改动
- 导出弹窗：
  - 模板选择：综报 / 晚报。
  - 期号输入：`period`、`total_period`，默认填入后端返回的建议值，允许用户修改。
  - 导出模式：预览开关（“预览”）；可选完整/增量模式（如需）。
  - “标记为已导出”勾选（默认开）。预览时灰掉且为关。
- 交互流程建议：
  - 打开弹窗时请求“导出预览/建议”接口获取：建议期号、默认模板文本预览。
  - 用户修改期号/模板/模式后，点击“预览”仅刷新文本；点击“正式导出”才写文件并按勾选标记 exported。

## 多次导出场景的处理选项
- 选项 A：导出模式 + 标记勾选（推荐）
  - 预览：`dry_run=true`，不标记。
  - 正式导出：`dry_run=false`，可选 `mark_exported`（默认 true）。若需要补充导出，可暂时关闭标记。
- 选项 B：增量导出
  - `mode=incremental` 时只导出 `manual_decided_at` 大于上次导出时间的记录；需要在后端记录每次导出时间/期号。
  - `mode=full` 保持现有逻辑。
- 选项 C：延迟归档
  - 导出不立即清空 selected，用户点击“完成导出并归档”时再标记 exported。

## 待确认
1) period/total 的自增规则（按模板还是全局？起始值？）。
2) 是否需要增量模式，还是 A 方案（标记勾选+预览）即可。
3) 预览是否只需返回文本（不写文件）即可满足需求。
