# 新闻流水线近期改造计划（最小实现）

## 目标
- **情感标签**：为每篇文章生成正向或负向标签，并存储置信度。
- **重复检测**：利用正文哈希与相似度指纹识别重复新闻，在候选列表中剔除或折叠重复项。

本阶段仅改动 `raw_articles`，其余表和流程保持不变。

## 数据库调整（仅 `raw_articles`）
- `content_hash` (`text`)：正文的哈希值（建议 SHA256）；用于快速发现完全重复的文章。  
  - 索引：`BTREE (content_hash)`，便于按哈希查询。
- `fingerprint` (`text` 或 `bytea`)：相似度指纹（如 SimHash/MinHash）；用于识别内容高度相似但不完全相同的文章。  
  - 索引：酌情建立（如 `BTREE (fingerprint)` 或 `GIN`/`SP-GiST`，取决于具体实现）。  
  - 若存储为 `bytea`，需在应用层统一序列化方式。
- `primary_article_id` (`text`，可空)：指向保留的主文章 ID；若为主文则等于 `article_id` 本身。  
  - 索引：`BTREE (primary_article_id)`，便于按主文查询其重复集合。  
  - 写入策略：当识别出重复文章时，将从文的 `primary_article_id` 设置为主文 ID；主文保持空值或自身 ID。
- `sentiment_label` (`text`)：情感标签，取值 `positive` 或 `negative`。
- `sentiment_confidence` (`numeric`)：情感判断置信度（0~1）。
- （可选）后续若需要回溯模型版本或处理时间，再追加相应字段。

> 迁移脚本需为已有历史数据填充默认值（可先置空），并为新旧字段补充必要的非空/唯一约束判断。

## 处理流程
1. **采集写入**
   - 爬虫在写入 `raw_articles` 时直接计算 `content_hash`；如使用异步处理，可先置空并加入补算任务。
   - 指纹计算可同步完成，或将缺失记录加入“指纹补算队列”。
   - 推荐使用统一工具函数，避免多处重复实现。

2. **指纹补算任务**
   - 批量读取 `fingerprint IS NULL` 的记录，调用选定算法（如 SimHash）生成指纹并写回。
   - 保留算法与参数配置（例如在配置文件或环境变量中），便于后续切换或重算。

3. **情感分类任务**
   - 执行“两段式”策略：先调用小模型（`.env` 中 `SENTIMENT_SMALL_MODEL_NAME`），若置信度低于 `SENTIMENT_CONFIDENCE_THRESHOLD` 再调用大模型（`SENTIMENT_MODEL_NAME`）。  
   - 将最终标签与置信度写入 `raw_articles` 对应字段。必要时记录低置信度样本以供人工复核。
   - 首次上线可对历史文章批量跑一次，保证老数据与新数据一致。

4. **重复识别与过滤**
   - **完全重复**：`content_hash` 相同则视为重复。可按发布时间或抓取时间只保留第一条，其余在候选列表中过滤或折叠显示。  
   - **高度相似**：若指纹距离低于阈值（需通过实验确定），将文章归入同一重复集合，并写入 `primary_article_id`（主文写回自身 ID，从文写回主文 ID）。  
   - 生成候选列表或报告时，优先展示 `primary_article_id = article_id`（或为空）的主文；对于从文，可折叠展示或直接剔除。

## 运维与监控
- **指标**：关注情感标签分布（正/负比例）、大模型调用占比、重复命中率、指纹生成成功率。
- **重算策略**：当算法或阈值调整时，按时间段重新计算哈希/指纹或情感结果，避免历史数据不一致。
- **配置管理**：在 `.env` 中维护模型名称、阈值及指纹算法参数；上线前确认所有任务读取相同配置。
- **备份与回溯**：保留原始 `content_markdown` 及新增字段的初始值，确保未来扩展事件聚合或评分时无需再次抓取源数据。
