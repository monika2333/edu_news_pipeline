# 项目需求文档 (PRD)：教育新闻流水线交互式控制台

## 1. 项目背景与目标

当前痛点：目前的教育新闻流水线（Edu News Pipeline）在最终输出环节依赖人工手动编辑 TXT 文件。用户需要从大量生成的新闻中手动筛选、删除、修改，效率低下且容易出错。

项目目标：开发一个基于 Web 的交互式控制台（Dashboard），取代 TXT 编辑流程。

核心价值：

1. **可视化筛选**：通过网页界面快速浏览、勾选保留新闻（白名单模式）。
2. **批量处理**：实现“未勾选即自动丢弃”的高效逻辑。
3. **解耦导出**：人工筛选与最终导出动作分离，支持全天多次筛选，按需一次性导出。

## 2. 技术栈选型

- **前端/交互框架**：`Streamlit` (Python)
  - *理由*：开发速度快，能直接复用现有后端代码，无缝对接 Python/PostgreSQL 环境。
- **数据库**：PostgreSQL (沿用现有架构)
- **语言**：Python 3.x

## 3. 核心业务流程 (Workflow)

1. **数据接入 (Backend)**：现有的爬虫/打分脚本继续运行（每15分钟一次），将新闻写入数据库，状态标记为 `pending`。
2. **人工筛选 (Dashboard)**：
   - 用户打开控制台，系统分页读取 `pending` 状态的新闻。
   - 用户勾选需要保留的新闻（默认不勾选）。
   - 用户点击“下一页/确认”按钮。
   - 系统更新数据库：勾选的变为 `approved`（进入备选池），未勾选的变为 `discarded`（丢弃）。
3. **最终导出 (Export)**：
   - 用户点击“一键导出日报”按钮。
   - 系统读取所有 `approved` 状态的新闻，生成格式化文本。
   - 系统将这些新闻状态更新为 `exported`（归档）。

## 4. 功能详细需求

### 4.1 侧边栏 (Sidebar) - 状态看板

- 显示当前数据库统计信息：
  - **待审核 (Pending)**：[数量] 条
  - **备选池 (Staging)**：[数量] 条 (已筛选但未导出)
  - **今日已导出**：[数量] 条
- **主操作按钮**：【生成并导出日报】（点击后触发导出逻辑）。

### 4.2 主界面 - 待审核新闻列表

- **数据源**：从数据库查询状态为 `pending` 的记录，按分数 (`score`) 倒序排列。
- **分页机制**：为防止页面过长，每次只加载 N 条（建议默认 20 条）。
- **新闻卡片 (Card/Row)**：
  - **复选框 (Checkbox)**：标签为“留用 (Keep)”，默认 **未选中**。
  - **标题**：显示新闻标题。
  - **摘要 (Text Area)**：显示 LLM 生成的摘要，**必须可编辑**。用户修改后的内容需在提交时保存。
  - **元数据**：显示来源、分数等辅助信息。

### 4.3 交互逻辑 - 批处理

- **底部按钮**：【确认本页并处理下一批】
- **点击后的动作**：
  1. 获取当前页所有新闻的 ID。
  2. **逻辑判断**：
     - `ID` 在勾选列表中 -> 更新 DB 状态为 `approved`，并更新摘要内容（如有修改）。
     - `ID` 不在勾选列表中 -> 更新 DB 状态为 `discarded`。
  3. **刷新页面**：重新运行查询，加载下一批 `pending` 新闻。
  4. **容错**：如果当前页没有勾选任何新闻，弹出二次确认提示（“本页未选中任何新闻，将全部丢弃？”），防止误触。

### 4.4 导出模块

- **触发**：点击侧边栏的【生成并导出日报】按钮。
- **逻辑**：
  1. 查询所有状态为 `approved` 的新闻。
  2. 按照既定格式（如：按来源分类、按分数排序、添加 Emoji 等）拼接文本。
  3. 在界面上显示最终文本（Code Block），提供“复制到剪贴板”功能。
  4. (可选) 自动调用飞书 Webhook 发送。
  5. **状态流转**：将这批 `approved` 新闻的状态更新为 `exported`，防止重复导出。

## 5. 数据库交互与状态机 (State Machine)

**开发任务说明**：请根据实际数据库表结构（需用户提供 `Table Schema`）实现以下状态流转。假设表名为 `articles`，状态字段为 `status`。

| **动作**           | **初始状态** | **目标状态** | **说明**                 |
| ------------------ | ------------ | ------------ | ------------------------ |
| **爬虫入库**       | (New)        | `pending`    | 后端自动完成，控制台只读 |
| **用户勾选并提交** | `pending`    | `approved`   | 进入“备选池”，等待导出   |
| **用户未勾选提交** | `pending`    | `discarded`  | 被视为垃圾数据丢弃       |
| **点击导出按钮**   | `approved`   | `exported`   | 最终生成日报，归档       |

## 6. 给开发者的执行提示 (Prompt Context)

请按以下步骤开发 `dashboard.py`：

1. **环境配置**：检查 `requirements.txt`，确保包含 `streamlit`, `psycopg2-binary` (或 `sqlalchemy`)。
2. **数据库连接**：
   - 使用 `st.cache_resource` 创建持久化的数据库连接函数，避免每次刷新页面都重连。
   - 读取现有的 `.env` 或 `config` 文件获取数据库凭证。
3. **Session State 管理**：
   - 使用 `st.session_state` 暂存当前页面的编辑内容，确保翻页逻辑顺畅。
4. **UI 构建**：
   - 使用 `st.form` 将列表包裹，确保用户点完所有勾选后，点击一次“提交”按钮才统一与数据库交互。
5. **SQL 预备**：
   - 编写 Update 语句，支持批量更新（例如 `UPDATE table SET status = 'discarded' WHERE id IN (...)`）。

**附：待确认信息（需在编码前由用户提供）**

- 数据库表名 (Table Name)
- 关键字段名：主键(ID), 标题(Title), 摘要(Summary), 状态(Status), 分数(Score)