# 导出模板改造方案（综报 / 晚报）

## 目标
在网页导出时直接生成最终排版文本，支持两个模板：
- 综报：分组顺序【京内负面】【京内正面】【京外负面】，包含头部信息。
- 晚报：分组顺序【京内正面】【京外正面】，编号样式不同。

## 数据分组与排序
- 分组依据：
  - 地域：`is_beijing_related` => 京内/京外。
  - 情感：`sentiment_label` => 正面/负面。
- 排序：沿用现有 `manual_rank` 优先，其次 score，再其次发布时间。

## 模板排版（示例）
- 综报头部三行：
  1) `首都教育每日舆情综报`
  2) `{year}年第{period}期（总第{total}期）`
  3) `{date}`（YYYY年MM月DD日）
- 综报分组格式：
  - 【京内负面】每条：`★ 标题` 换行 `摘要（来源）`
  - 【京内正面】每条：`■ 标题` 换行 `摘要（来源）`
  - 【京外负面】每条：`▲ 标题` 换行 `摘要（来源）`
- 晚报格式：
  - 【京内正面】：编号 `一、二、三...` + 标题；下一行 `摘要（来源）`
  - 【京外正面】：同上编号。

## 后端改动
- `ExportRequest` 增加 `template` 字段（如 `zongbao`/`wanbao`），可选 `mark_exported` 保持默认 true。
- `export_batch`：
  - 根据 `template` 选择分组顺序与格式函数。
  - 生成模板化 `content` 返回，同时写文件（沿用唯一文件名逻辑）。
  - 返回值包含 `template`，便于前端提示。
- 期号/总期号来源：需要确定是否由前端输入或后端自动计算；若需要，`ExportRequest` 可增加 `period`、`total_period` 字段。

## 前端改动
- 导出按钮旁增加模板选择（下拉或单选：综报/晚报）。
- 调用 `/api/manual_filter/export` 时携带 `template`（及可选期号字段）。
- 导出弹窗直接展示后端返回的排版文本。

## 待确认问题
1) 综报期号、总期号如何获取：手动输入还是自动累加？
2) 晚报是否需要日期或额外头部信息？
3) 导出后仍自动标记为 `exported` 吗？如需禁用，可通过 `mark_exported` 控制。
