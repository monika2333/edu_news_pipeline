# 导出模板改造方案（综报 / 晚报 / 预览）

## 目标
- 导出时直接生成最终排版文本，支持综报/晚报两种模板。
- 支持“预览”：不写文件、不标记 exported，仅返回排版文本供复制。
- 支持期号自动计算，前端可手动覆盖。

## 数据分组与排序
- 分组依据：地域 `is_beijing_related`（京内/京外）、情感 `sentiment_label`（正面/负面）。
- 排序：沿用 `manual_rank` 优先，其次 score，再其次发布时间。

## 模板排版
- 综报头部三行：
  1) `首都教育每日舆情综报`
  2) `{year}年第{period}期（总第{total}期）`
  3) `{date}`（YYYY年MM月DD日）
- 综报栏目映射与符号：
  - 【重点关注舆情】= 京内负面，`★ 标题` 换行 `摘要（来源）`
  - 【新闻信息纵览】= 京内正面，`■ 标题` 换行 `摘要（来源）`
  - 【国内教育热点】= 京外负面，`▲ 标题` 换行 `摘要（来源）`

- 晚报头部三行（固定文案）：
  1) `首都教育舆情`
  2) `总第{total}期`
  3) `{date}`（YYYY年MM月DD日）
- 晚报栏目映射与编号：
  - 【舆情速览】= 京内正面，编号 `一、二、三...` + 标题；下一行 `摘要（来源）`
  - 【舆情参考】= 京外正面，编号同上。

## 期号规则
- 综报与晚报独立计数。
- 综报：每天自增 1 期。
- 晚报：每天自增 2 期。
- 后端自动计算 `period/total`；如前端传入则直接使用、跳过计算。

## 后端改动
- `ExportRequest` 增加字段：
  - `template`: `zongbao` / `wanbao`
  - `period`, `total_period`: 可选；为空则按规则自动计算。
  - `mark_exported`: 默认 true，控制是否标记导出。
  - `dry_run`: 预览开关，true 时不写文件、不标记 exported。
- `export_batch` 逻辑：
  - 按模板选择分组顺序与格式化函数（头部和栏目名称不同）。
  - `dry_run=true` 时仅生成文本，不写文件、不更新状态。
  - 返回实际使用的 `period/total`、`template`，便于前端提示。
- 自动期号实现思路：
  - 以模板维度查询最近一次导出记录，按“每天+1”或“每天+2”计算下一期。
  - 需存储最后一次的 period/total 与日期；查不到则使用起始值。

## 前端改动
- 导出弹窗：
  - 模板选择：综报 / 晚报。
  - 期号输入：`period`、`total_period`，默认填入后端建议值，可手动修改。
  - 预览开关：“预览”模式开启时强制 `dry_run=true`、禁用标记。
  - “标记为已导出”勾选（默认开）；预览时灰掉且关闭。
- 交互流程：
  - 打开弹窗时请求“导出预览/建议”接口获取：建议期号、默认模板文本预览。
  - 用户修改后点击“预览”仅刷新文本；点击“正式导出”才写文件并按勾选标记 exported。

## 多次导出策略
- 不做增量/延迟归档等逻辑，依靠“预览”先看文本，最后一次用“导出”正式落盘并标记。

## 预览行为
- 仅返回排版文本，不写文件、不更新任何状态。
